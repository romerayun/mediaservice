<?php

namespace App\Http\Controllers;

use App\Models\ActiveAd;
use App\Models\Claim;
use App\Models\ClaimFile;
use App\Models\Goal;
use App\Models\HistoryClaim;
use App\Models\HistoryPayment;
use App\Models\StatusClaim;
use App\Models\StatusPayment;
use App\Models\TemporaryFile;
use App\Models\UserM;
use Carbon\Carbon;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use mysql_xdevapi\Exception;

class ClaimController extends Controller
{
    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        abort(404);
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create()
    {
        abort(404);
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        $validatedData = $request->validate(
            [
                'service_id' => 'required|integer',
                'deadlineClaim' => 'required|date',
                'amount' => 'numeric',
            ],
            [
                'service_id.integer' => '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞',
                'deadlineClaim.required' => '–ü–æ–ª–µ —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º',
                'deadlineClaim.date' => '–ü–æ–ª–µ —Å—Ä–æ–∫ –≤—ã–ø–æ–ª–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–∞—Ç—ã',
                'amount.numeric' => '–ü–æ–ª–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ñ–æ—Ä–º–∞—Ç–µ —á–∏—Å–ª–∞',
            ]
        );

        DB::beginTransaction();
        try {

            if ($request->package_id == '0') {
                $request->merge([
                    'package_id' => null,
                ]);
            }

            $request->merge([
                'deadline' => $request->deadlineClaim,
                'user_id' => null,
                'creator' => Auth::user()->id,
            ]);


            $claim = Claim::create($request->all());

            if ($request->hasFile('brif')) {
                $folder = date("Y-m-d");
                $brifFilepath = $request->file('brif')->store("images/{$folder}");

                $claim->brif = $brifFilepath;
                $claim->save();
            }

            $claimId = $claim->id;

            if ($request->filepond) {
                if (count($request->filepond) != 0) {

                    $folder = uniqid() . '-' . now()->timestamp;
                    Storage::disk('public')->makeDirectory('materials/' . $folder);

                    $oldFolders = array();
                    foreach ($request->filepond as $file) {
                        $claimFile = ClaimFile::create([
                            'claim_id' => $claimId,
                        ]);

                        $temporaryFile = TemporaryFile::where('folder', $file)->first();
                        if ($temporaryFile) {

                            $oldFile = 'materials/tmp/' . $file . '/' . $temporaryFile->filename;
                            $newFile = 'materials/' . $folder . '/' . $temporaryFile->filename;
                            Storage::copy($oldFile, $newFile);

                            $claimFile->file = $newFile;
                            $claimFile->save();
                        }

                        $temporaryFile->delete();

                        $oldFolders[] = $file;
                    }

                    foreach ($oldFolders as $folder) {
                        Storage::deleteDirectory('materials/tmp/' . $folder);
                    }

                }
            }

            $statusClaimId = StatusClaim::where('name', '=', '–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞')->get()->first()->id;
            HistoryClaim::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusClaimId,
                'comment' => '–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞',
                'claim_id' => $claimId,
            ]);

            $statusPayment = StatusPayment::where('name', '=', '–ù–µ –æ–ø–ª–∞—á–µ–Ω')->get()->first()->id;
            HistoryPayment::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusPayment,
                'comment' => '–ó–∞—è–≤–∫–∞ –Ω–µ –æ–ø–ª–∞—á–µ–Ω–∞',
                'claim_id' => $claimId,
            ]);

            if ($request->isInvoice) {
                $statusPayment = StatusPayment::where('name', '=', '–°—á–µ—Ç –Ω–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω')->get()->first()->id;
                HistoryPayment::create([
                    'user_id' => Auth::user()->id,
                    'status_id' => $statusPayment,
                    'comment' => '–°—á–µ—Ç –Ω–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω',
                    'claim_id' => $claimId,
                ]);
            }

            DB::commit();
            $request->session()->flash('success', '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ üëç');
            return back();

        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢');
            return back();
        }
//        dd($request);
    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show($id)
    {
        $claim = Claim::find($id);
        $countAdds = claimsAdds($claim);
        $statusesClaim = StatusClaim::where('isVisible', 1)->get();
        $users = UserM::all();
        $activeAd = ActiveAd::firstWhere('claim_id', $id);
        return view('claims.show', compact('claim', 'countAdds', 'statusesClaim', 'users', 'activeAd'));
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit($id)
    {
        abort(404);
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, $id)
    {
        abort(404);
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        abort(404);
    }

    public function claimInputs()
    {
        abort(404);
    }

    public function claimDistribution() {
        $claims = Claim::whereNull('user_id')
            ->with('service')
            ->whereHas('service', function ($q) {
                $q->where('user_id', \Illuminate\Support\Facades\Auth::user()->id);
            })
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        claimsIsRead();

        $users = UserM::all();

        return view('claims.distribution', compact('claims', 'users'));
    }

    public function claimDistributionComplete() {
        $claims = Claim::whereNotNull('user_id')
            ->with('service')
            ->whereHas('service', function ($q) {
                $q->where('user_id', \Illuminate\Support\Facades\Auth::user()->id);
            })
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        $users = UserM::all();

        return view('claims.distribution-complete', compact('claims', 'users'));
    }

    public function claimUserUpdate($cliam, Request $request) {
        $validatedData = $request->validate(
            [
                'user_id' => 'required|integer',
            ],
            [
                'user_id.required' => '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞',
                'user_id.integer' => '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞',
            ]
        );

        DB::beginTransaction();

        try {
            $cliam = Claim::find($cliam);
            $cliam->user_id = $request->user_id;
            $cliam->save();
            DB::commit();

            $statusClaimId = StatusClaim::where('name', '=', '–ù–∞–∑–Ω–∞—á–µ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π')->get()->first()->id;
            HistoryClaim::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusClaimId,
                'comment' => '–ù–∞–∑–Ω–∞—á–µ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏',
                'claim_id' => $cliam->id,
            ]);

            $oldGoal = Goal::where('claim_id', $cliam->id);
            if ($oldGoal->count() != 0) {
                $oldGoal->delete();
            }

            $goal = new Goal;
            $goal->exposed = Auth::user()->id;
            $goal->user_id = $request->user_id;
            $goal->client_id = $cliam->client_id;
            $goal->claim_id = $cliam->id;
            $goal->text = "–ó–∞—è–≤–∫–∞ –¥–ª—è –≤—ã–ø–æ–ª–µ–Ω–µ–Ω–∏—è - " . $cliam->service->name;
            $goal->start_date = Carbon::parse($cliam->created_at)->format('Y-m-d 00:00:00');
            $goal->deadline = Carbon::parse($cliam->deadline)->addDay()->format('Y-m-d 00:00:00');
            $goal->allDay = 1;
            $goal->save();


            DB::commit();

            return redirect()->back()->with('success', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã üëç');
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢' . $exception);
            return back();
        }
    }

    public function claimAccept($cliam, Request $request) {

        DB::beginTransaction();

        try {
            $cliam = Claim::find($cliam);
            $cliam->user_id = Auth::user()->id;
            $cliam->isRead = 1;
            $cliam->save();

            $statusClaimId = StatusClaim::where('name', '=', '–ù–∞–∑–Ω–∞—á–µ–Ω –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π')->get()->first()->id;
            HistoryClaim::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusClaimId,
                'comment' => '–ü—Ä–∏–Ω—è–ª –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
                'claim_id' => $cliam->id,
            ]);

            $oldGoal = Goal::where('claim_id', $cliam->id);
            if ($oldGoal->count() != 0) {
                $oldGoal->delete();
            }

            $goal = new Goal;
            $goal->exposed = Auth::user()->id;
            $goal->user_id = Auth::user()->id;
            $goal->client_id = $cliam->client_id;
            $goal->claim_id = $cliam->id;
            $goal->text = "–ó–∞—è–≤–∫–∞ –¥–ª—è –≤—ã–ø–æ–ª–µ–Ω–µ–Ω–∏—è - " . $cliam->service->name;
            $goal->start_date = Carbon::parse($cliam->created_at)->format('Y-m-d 00:00:00');
            $goal->deadline = Carbon::parse($cliam->deadline)->addDay()->format('Y-m-d 00:00:00');
            $goal->allDay = 1;
            $goal->save();


            DB::commit();

            return redirect()->back()->with('success', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã üëç');
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢' . $exception);
            return back();
        }
    }


    public function storeHistory($id, Request $request) {
        $validatedData = $request->validate(
            [
                'status_id' => 'required|integer',
            ],
            [
                'status_id.required' => '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞',
                'status_id.integer' => '–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞',
            ]
        );

        $request->merge([
            'claim_id' => $id,
            'user_id' => Auth::user()->id,
        ]);

        DB::beginTransaction();

        try {
            HistoryClaim::create($request->all());
            DB::commit();
            $request->session()->flash('success', '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã üëç');
            return back();
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢');
            return back();
        }


    }

    public function claimGroups() {

        $claims = Claim::whereNull('user_id')
            ->with('service')
            ->whereHas('service', function ($q) {
                $q->where('group_id', Auth::user()->role->group_id);
            })
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        $users = UserM::all();


        return view('claims.claim-group', compact('claims', 'users'));
    }

    public function claimsMy() {

        $claims = Claim::where('user_id', Auth::user()->id)
            ->where('isClose', 0)
            ->with('service')
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        $users = UserM::all();

        return view('claims.claims-my', compact('claims', 'users'));
    }

    public function claimsClosed($id, Request $request) {
        $validatedData = $request->validate(
            [
                'commentClose' => 'required',
            ],
            [
                'commentClose.required' => '–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –∑–∞–∫—Ä—ã—Ç–∏—è –∑–∞—è–≤–∫–∏',
            ]
        );

        DB::beginTransaction();

        try {
            $cliam = Claim::find($id);
            $cliam->isClose = 1;
            $cliam->commentClose = $request->commentClose;
            $cliam->save();

            $statusClaimId = StatusClaim::where('name', '=', '–ó–∞—è–≤–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞')->get()->first()->id;
            HistoryClaim::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusClaimId,
                'comment' => $request->commentClose,
                'claim_id' => $cliam->id,
            ]);

            DB::commit();

            return redirect()->back()->with('success', '–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞ üëç');
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢' . $exception);
            return back();
        }
    }

    public function getClaimsClosed() {

        $claims = Claim::where('user_id', Auth::user()->id)
            ->where('isClose', 1)
            ->with('service')
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        $users = UserM::all();

        return view('claims.claims-close', compact('claims', 'users'));
    }


    public function createInvoice() {

        $claims = Claim::where('isInvoice', 1)
            ->whereNull('invoice')
            ->with('service')
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        return view('claims.invoice', compact('claims'));
    }

    public function storeInvoice($id, Request $request)
    {
        $name = 'invoice'.$request->number;
        $validatedData = $request->validate(
            [
                 $name => 'required',
            ],
            [
                "$name.required" => '–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è',
            ]
        );


        DB::beginTransaction();

        try {

            $claim = Claim::find($id);
            if ($request->hasFile('invoice'.$request->number)) {
                $folder = date("Y-m-d");
                $invoiceFile = $request->file('invoice'.$request->number)->store("invoices/{$folder}");

                $claim->invoice = $invoiceFile;
                $claim->save();
            }


            $statusClaimId = StatusClaim::where('name', '=', '–°—á–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω')->get()->first()->id;
            HistoryClaim::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusClaimId,
                'comment' => "–í—ã—Å—Ç–∞–≤–ª–µ–Ω —Å—á–µ—Ç",
                'claim_id' => $claim->id,
            ]);

            $statusPayment = StatusPayment::where('name', '=', '–°—á–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω')->get()->first()->id;
            HistoryPayment::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusPayment,
                'comment' => '–í—ã—Å—Ç–∞–≤–ª–µ–Ω —Å—á–µ—Ç',
                'claim_id' => $claim->id,
            ]);


            DB::commit();

            return redirect()->back()->with('success', '–°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω üëç');
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢' . $exception);
            return back();
        }
    }


    public function closedInvoice()
    {
        $claims = Claim::where('isInvoice', 1)
            ->whereNotNull('invoice')
            ->with('service')
            ->orderBy('created_at', 'desc')
            ->paginate(10);

        return view('claims.close-invoice', compact('claims'));
    }

    public function updateInvoice($id, Request $request)
    {
        $name = 'invoice'.$request->number;
        $validatedData = $request->validate(
            [
                $name => 'required',
            ],
            [
                "$name.required" => '–ü–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è',
            ]
        );


        DB::beginTransaction();

        try {

            $claim = Claim::find($id);
            if ($request->hasFile('invoice'.$request->number)) {
                Storage::delete($claim->invoice);
                $folder = date("Y-m-d");
                $invoiceFile = $request->file('invoice'.$request->number)->store("invoices/{$folder}");

                $claim->invoice = $invoiceFile;
                $claim->save();
            }


            $statusClaimId = StatusClaim::where('name', '=', '–°—á–µ—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω')->get()->first()->id;
            HistoryClaim::create([
                'user_id' => Auth::user()->id,
                'status_id' => $statusClaimId,
                'comment' => "–û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É",
                'claim_id' => $claim->id,
            ]);

            DB::commit();

            return redirect()->back()->with('success', '–°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω üëç');
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢' . $exception);
            return back();
        }
    }


    public function storeAd($id, Request $request) {
        $validatedData = $request->validate(
            [
                'range_date_hidden' => 'required',
            ],
            [
                "range_date_hidden.required" => '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏',
            ]
        );

        $date = explode('|', $request->range_date_hidden);

        $startDate = trim($date[0]) . " 00-00-00";
        $endDate = trim($date[1]) . " 00-00-00";

        DB::beginTransaction();

        try {

            $request->merge([
                'claim_id' => $id,
                'start_date' => $startDate,
                'end_date' => $endDate,
                'user_id' => Auth::user()->id,
            ]);

            ActiveAd::create($request->all());

            DB::commit();

            return redirect()->back()->with('success', '–†–µ–∫–ª–∞–º–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞ üëç');
        } catch (\Exception $exception) {
            DB::rollback();
            $request->session()->flash('error', '–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ä–µ–∫–ª–∞–º–Ω–æ–π –∫–∞–º–ø–∞–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ üò¢');
            return back();
        }

    }

    public function deleteAd($id) {
        $ad = ActiveAd::find($id);
        $ad->delete();
        return redirect()->back()->with('success', '–†–µ–∫–ª–∞–º–Ω–∞—è –∫–∞–º–ø–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞ üëç');
    }

    public function getActiveAd() {

        $activeAds = Claim::whereHas('activeAd', function ($q) {
                $q->where('end_date', '>=', now()->second(0)->minute(0)->hour(0));
            })
            ->where('creator', Auth::user()->id)
            ->get();

        return view('activeAd.index', compact('activeAds'));
    }

    public function getPastActiveAd() {

        $activeAds = Claim::whereHas('activeAd', function ($q) {
            $q->where('end_date', '<=', now()->second(0)->minute(0)->hour(0));
        })
            ->where('creator', Auth::user()->id)
            ->get();

        return view('activeAd.past', compact('activeAds'));
    }


}
